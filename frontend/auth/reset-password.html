{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - GTX</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body>
    <div class="container">
        <div class="card">
            <h1>Reset Password</h1>
            <p class="text-center text-muted mb-20">
                Enter the 6-digit code sent to<br>
                <strong id="emailDisplay"></strong>
            </p>
            <form id="resetForm">
                <div class="form-group">
                    <label for="code">Reset Code</label>
                    <div class="pin-input-group">
                        <input type="text" class="pin-input" maxlength="1" data-index="0">
                        <input type="text" class="pin-input" maxlength="1" data-index="1">
                        <input type="text" class="pin-input" maxlength="1" data-index="2">
                        <input type="text" class="pin-input" maxlength="1" data-index="3">
                        <input type="text" class="pin-input" maxlength="1" data-index="4">
                        <input type="text" class="pin-input" maxlength="1" data-index="5">
                    </div>
                    <input type="hidden" id="code" name="code">
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password"
                        minlength="8" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword"
                        placeholder="Confirm new password" required>
                </div>
                <button type="submit" class="btn btn-primary">Reset Password</button>
            </form>
            <p class="text-center mt-20">
                <a href="forgot-password.html" class="link">Request new code</a>
            </p>
        </div>
    </div>

    <script src="{% static 'js/api.js' %}"></script>
    <script>
        const email = sessionStorage.getItem('resetEmail');

        if (!email) {
            window.location.href = 'forgot-password.html';
        }

        document.getElementById('emailDisplay').textContent = email;

        // PIN input handling
        const pinInputs = document.querySelectorAll('.pin-input');

        pinInputs.forEach((input, index) => {
            input.addEventListener('input', function (e) {
                this.value = this.value.replace(/[^0-9]/g, '');

                if (this.value && index < pinInputs.length - 1) {
                    pinInputs[index + 1].focus();
                }
                updateHiddenCode();
            });

            input.addEventListener('keydown', function (e) {
                if (e.key === 'Backspace' && !this.value && index > 0) {
                    pinInputs[index - 1].focus();
                }
            });

            input.addEventListener('paste', function (e) {
                e.preventDefault();
                const paste = (e.clipboardData || window.clipboardData).getData('text');
                const digits = paste.replace(/[^0-9]/g, '').slice(0, 6);

                digits.split('').forEach((digit, i) => {
                    if (pinInputs[i]) {
                        pinInputs[i].value = digit;
                    }
                });
                updateHiddenCode();
            });
        });

        function updateHiddenCode() {
            const code = Array.from(pinInputs).map(input => input.value).join('');
            document.getElementById('code').value = code;
        }

        document.getElementById('resetForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = this;
            const submitBtn = form.querySelector('button[type="submit"]');
            const code = document.getElementById('code').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (code.length !== 6) {
                UI.showAlert(form, 'Please enter the complete 6-digit code');
                return;
            }

            if (newPassword !== confirmPassword) {
                UI.showAlert(form, 'Passwords do not match');
                return;
            }

            if (newPassword.length < 8) {
                UI.showAlert(form, 'Password must be at least 8 characters');
                return;
            }

            UI.showLoader(submitBtn);

            try {
                const response = await api.verifyPasswordReset(email, code, newPassword);
                const data = await response.json();

                if (response.ok) {
                    sessionStorage.removeItem('resetEmail');
                    UI.showAlert(form, 'Password reset successful! Redirecting to login...', 'success');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    UI.showAlert(form, data.detail || 'Password reset failed. Please try again.');
                }
            } catch (error) {
                UI.showAlert(form, 'Network error. Please try again.');
            } finally {
                UI.hideLoader(submitBtn);
            }
        });
    </script>
</body>

</html>