<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 3 Verification - GTX</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .level-info {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .level-info h3 {
            margin-bottom: 10px;
            color: white;
        }

        .level-info ul {
            margin: 0;
            padding-left: 20px;
        }

        .level-info li {
            margin-bottom: 5px;
        }

        .status-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-info.approved {
            background: #d4edda;
            border-color: #28a745;
        }

        .status-info.rejected {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .status-info.not-eligible {
            background: #e2e3e5;
            border-color: #6c757d;
        }

        .image-preview-small {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container card-wide">
        <nav class="nav">
            <div class="nav-brand">GTX</div>
            <div class="nav-links">
                <a href="../profile/dashboard.html">Dashboard</a>
                <a href="../profile/transaction-pin.html">Transaction PIN</a>
                <a href="../profile/profile-picture.html">Profile Picture</a>
                <a href="level2.html">Upgrade Account</a>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </nav>

        <div class="card">
            <h2>Upgrade to Level 3</h2>

            <div class="level-info">
                <h3>Level 3 Benefits</h3>
                <ul>
                    <li>Transaction limit increased to â‚¦50,000,000</li>
                    <li>Unlimited features access</li>
                    <li>Dedicated account manager</li>
                    <li>Lowest transaction fees</li>
                </ul>
            </div>

            <div id="statusSection" class="hidden">
                <!-- Status will be shown here if already submitted -->
            </div>

            <div id="formSection">
                <p class="text-muted mb-20">
                    Please provide your address details and upload verification documents.
                </p>

                <form id="level3Form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="houseAddress1">House Address Line 1 *</label>
                            <input type="text" id="houseAddress1" name="houseAddress1" placeholder="Street address" required>
                        </div>
                        <div class="form-group">
                            <label for="houseAddress2">House Address Line 2</label>
                            <input type="text" id="houseAddress2" name="houseAddress2" placeholder="Apartment, suite, etc. (optional)">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nearestBusStop">Nearest Bus Stop *</label>
                            <input type="text" id="nearestBusStop" name="nearestBusStop" placeholder="Nearest landmark or bus stop" required>
                        </div>
                        <div class="form-group">
                            <label for="city">City *</label>
                            <input type="text" id="city" name="city" placeholder="City" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="state">State *</label>
                            <input type="text" id="state" name="state" placeholder="State" required>
                        </div>
                        <div class="form-group">
                            <label for="country">Country *</label>
                            <input type="text" id="country" name="country" value="Nigeria" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="proofOfAddress">Proof of Address Image *</label>
                            <input type="file" id="proofOfAddress" name="proofOfAddress" accept="image/*" required>
                            <p class="text-muted" style="font-size:12px;">Utility bill, bank statement, or any official document showing your address</p>
                            <img id="proofPreview" class="image-preview-small hidden" alt="Preview">
                        </div>
                        <div class="form-group">
                            <label for="faceVerification">Face Verification Image *</label>
                            <input type="file" id="faceVerification" name="faceVerification" accept="image/*" required>
                            <p class="text-muted" style="font-size:12px;">Clear selfie holding your ID document</p>
                            <img id="facePreview" class="image-preview-small hidden" alt="Preview">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Submit for Verification</button>
                </form>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        if (!requireAuth()) {
            // Redirect handled in requireAuth
        }

        // Check current status
        async function checkStatus() {
            try {
                const response = await api.getCurrentUser();
                if (response.ok) {
                    const user = await response.json();

                    if (user.level === 'Level 3') {
                        showStatus('approved', 'You are already Level 3!');
                        document.getElementById('formSection').classList.add('hidden');
                        return;
                    }

                    if (user.level !== 'Level 2') {
                        showStatus('not-eligible', 'You must be Level 2 before applying for Level 3. Please complete Level 2 verification first.');
                        document.getElementById('formSection').classList.add('hidden');
                        return;
                    }

                    if (user.level3_credentials) {
                        const status = user.level3_credentials.status;
                        if (status === 'Pending') {
                            showStatus('pending', 'Your Level 3 verification is pending approval.');
                        } else if (status === 'Rejected') {
                            showStatus('rejected', 'Your Level 3 verification was rejected. Please contact support.');
                        }
                        document.getElementById('formSection').classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Failed to check status:', error);
            }
        }

        function showStatus(type, message) {
            const statusSection = document.getElementById('statusSection');
            statusSection.className = `status-info ${type}`;
            statusSection.innerHTML = `<strong>${message}</strong>`;
            statusSection.classList.remove('hidden');
        }

        // Image previews
        function setupImagePreview(inputId, previewId) {
            document.getElementById(inputId).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById(previewId);
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        setupImagePreview('proofOfAddress', 'proofPreview');
        setupImagePreview('faceVerification', 'facePreview');

        // Form submission
        document.getElementById('level3Form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = this;
            const submitBtn = form.querySelector('button[type="submit"]');

            const data = {
                houseAddress1: document.getElementById('houseAddress1').value,
                houseAddress2: document.getElementById('houseAddress2').value,
                nearestBusStop: document.getElementById('nearestBusStop').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                country: document.getElementById('country').value,
                proofOfAddressImage: document.getElementById('proofOfAddress').files[0],
                faceVerificationImage: document.getElementById('faceVerification').files[0]
            };

            if (!data.proofOfAddressImage || !data.faceVerificationImage) {
                UI.showAlert(form, 'Please upload both required images');
                return;
            }

            UI.showLoader(submitBtn);

            try {
                const response = await api.submitLevel3Credentials(data);
                const responseData = await response.json();

                if (response.ok) {
                    UI.showAlert(form, 'Level 3 credentials submitted successfully!', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    UI.showAlert(form, responseData.detail || 'Submission failed. Please try again.');
                }
            } catch (error) {
                UI.showAlert(form, 'Network error. Please try again.');
            } finally {
                UI.hideLoader(submitBtn);
            }
        });

        checkStatus();
    </script>
</body>
</html>
