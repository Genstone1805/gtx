{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 2 Verification - GTX</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <style>
        .level-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .level-info h3 {
            margin-bottom: 10px;
            color: white;
        }

        .level-info ul {
            margin: 0;
            padding-left: 20px;
        }

        .level-info li {
            margin-bottom: 5px;
        }

        .status-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-info.approved {
            background: #d4edda;
            border-color: #28a745;
        }

        .status-info.rejected {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .image-preview-small {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container card-wide">
        <nav class="nav">
            <div class="nav-brand">GTX</div>
            <div class="nav-links">
                <a href="../profile/dashboard">Dashboard</a>
                <a href="../profile/transaction-pin">Transaction PIN</a>
                <a href="../profile/profile-picture">Profile Picture</a>
                <a href="level2" class="active">Upgrade Account</a>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </nav>

        <div class="card">
            <h2>Upgrade to Level 2</h2>

            <div class="level-info">
                <h3>Level 2 Benefits</h3>
                <ul>
                    <li>Transaction limit increased to â‚¦5,000,000</li>
                    <li>Access to premium features</li>
                    <li>Priority customer support</li>
                </ul>
            </div>

            <div id="statusSection" class="hidden">
                <!-- Status will be shown here if already submitted -->
            </div>

            <div id="formSection">
                <p class="text-muted mb-20">
                    Please provide your National Identification Number (NIN) and upload a clear image of your NIN slip
                    or card.
                </p>

                <form id="level2Form">
                    <div class="form-group">
                        <label for="nin">NIN (11 digits)</label>
                        <input type="text" id="nin" name="nin" placeholder="Enter your 11-digit NIN" maxlength="11"
                            pattern="[0-9]{11}" required>
                    </div>

                    <div class="form-group">
                        <label for="ninImage">NIN Slip/Card Image</label>
                        <input type="file" id="ninImage" name="ninImage" accept="image/*" required>
                        <img id="ninImagePreview" class="image-preview-small hidden" alt="Preview">
                    </div>

                    <button type="submit" class="btn btn-primary">Submit for Verification</button>
                </form>
            </div>

            <div class="mt-20 text-center">
                <p class="text-muted">Already Level 2?</p>
                <a href="level3" class="btn btn-secondary">Upgrade to Level 3</a>
            </div>
        </div>
    </div>

    <script src="{% static 'js/api.js' %}"></script>
    <script>
        if (!requireAuth()) {
            // Redirect handled in requireAuth
        }

        // Check current status
        async function checkStatus() {
            try {
                const response = await api.getCurrentUser();
                if (response.ok) {
                    const user = await response.json();

                    if (user.level === 'Level 2' || user.level === 'Level 3') {
                        showStatus('approved', 'You are already Level 2 or higher!');
                        document.getElementById('formSection').classList.add('hidden');
                        return;
                    }

                    if (user.level2_credentials) {
                        const status = user.level2_credentials.status;
                        if (status === 'Pending') {
                            showStatus('pending', 'Your Level 2 verification is pending approval.');
                        } else if (status === 'Rejected') {
                            showStatus('rejected', 'Your Level 2 verification was rejected. Please contact support.');
                        }
                        document.getElementById('formSection').classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Failed to check status:', error);
            }
        }

        function showStatus(type, message) {
            const statusSection = document.getElementById('statusSection');
            statusSection.className = `status-info ${type}`;
            statusSection.innerHTML = `<strong>${message}</strong>`;
            statusSection.classList.remove('hidden');
        }

        // NIN input - only allow digits
        document.getElementById('nin').addEventListener('input', function (e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // Image preview
        document.getElementById('ninImage').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('ninImagePreview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Form submission
        document.getElementById('level2Form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = this;
            const submitBtn = form.querySelector('button[type="submit"]');
            const nin = document.getElementById('nin').value;
            const ninImage = document.getElementById('ninImage').files[0];

            if (nin.length !== 11) {
                UI.showAlert(form, 'NIN must be exactly 11 digits');
                return;
            }

            if (!ninImage) {
                UI.showAlert(form, 'Please upload your NIN image');
                return;
            }

            UI.showLoader(submitBtn);

            try {
                const response = await api.submitLevel2Credentials(nin, ninImage);
                const data = await response.json();

                if (response.ok) {
                    UI.showAlert(form, 'Level 2 credentials submitted successfully!', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    UI.showAlert(form, data.detail || 'Submission failed. Please try again.');
                }
            } catch (error) {
                UI.showAlert(form, 'Network error. Please try again.');
            } finally {
                UI.hideLoader(submitBtn);
            }
        });

        checkStatus();
    </script>
</body>

</html>